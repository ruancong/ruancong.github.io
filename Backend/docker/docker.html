<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/images/logo.svg"><title>Docker | Notes</title><meta name="description" content="docker学习,docker零基础教程,docker学习笔记">
    <link rel="preload" href="/assets/style-CMopnafn.css" as="style"><link rel="stylesheet" href="/assets/style-CMopnafn.css">
    <link rel="modulepreload" href="/assets/app-B1tdEkzq.js"><link rel="modulepreload" href="/assets/docker.html-BhvXzK0p.js">
    <link rel="prefetch" href="/assets/index.html-BcBfJYfY.js" as="script"><link rel="prefetch" href="/assets/commands.html-GR-uHgBH.js" as="script"><link rel="prefetch" href="/assets/linux.html-DvblRFJU.js" as="script"><link rel="prefetch" href="/assets/MinIO.html-BjAm7a97.js" as="script"><link rel="prefetch" href="/assets/PostgreSQL.html-1SDF8Xm3.js" as="script"><link rel="prefetch" href="/assets/forget-lock-psw.html-DE2sq_ao.js" as="script"><link rel="prefetch" href="/assets/raft.html-DSBYLZ31.js" as="script"><link rel="prefetch" href="/assets/split-brain.html-A_mNyGb5.js" as="script"><link rel="prefetch" href="/assets/k8s.html-DTO_FAZM.js" as="script"><link rel="prefetch" href="/assets/network-basis.html-DN9HDASu.js" as="script"><link rel="prefetch" href="/assets/问题解决.html-BZT0c2tz.js" as="script"><link rel="prefetch" href="/assets/English-Grammar.html-DLXBGolJ.js" as="script"><link rel="prefetch" href="/assets/英语句子解析.html-Bic79aap.js" as="script"><link rel="prefetch" href="/assets/语法学习.html-D8hU5NxH.js" as="script"><link rel="prefetch" href="/assets/template.html-Bo7APyvp.js" as="script"><link rel="prefetch" href="/assets/nextjs.html-DeB-db1v.js" as="script"><link rel="prefetch" href="/assets/react-router.html-mf2GW20N.js" as="script"><link rel="prefetch" href="/assets/react.html-Dj1wSa9j.js" as="script"><link rel="prefetch" href="/assets/spingboot-3.x.html-CjJCiLV_.js" as="script"><link rel="prefetch" href="/assets/05-20.html-DilK2Vf8.js" as="script"><link rel="prefetch" href="/assets/05-21.html-s0jLYrgF.js" as="script"><link rel="prefetch" href="/assets/05-22.html-Cghv6ZBs.js" as="script"><link rel="prefetch" href="/assets/05-23.html-B1IuegAA.js" as="script"><link rel="prefetch" href="/assets/02-26.html-D37NWopz.js" as="script"><link rel="prefetch" href="/assets/01-03.html-CWCiXQD1.js" as="script"><link rel="prefetch" href="/assets/01-08.html-anYUuJPP.js" as="script"><link rel="prefetch" href="/assets/01-10.html-CI8aqoKc.js" as="script"><link rel="prefetch" href="/assets/01-15.html-xwyVSLZG.js" as="script"><link rel="prefetch" href="/assets/07-09.html-B5lE4GYZ.js" as="script"><link rel="prefetch" href="/assets/07-10.html-CzpPbPj2.js" as="script"><link rel="prefetch" href="/assets/07-11.html-CEf8K4vK.js" as="script"><link rel="prefetch" href="/assets/07-12.html-j62vEJAH.js" as="script"><link rel="prefetch" href="/assets/07-13.html-BTd8C7tK.js" as="script"><link rel="prefetch" href="/assets/07-14.html-D624ywEa.js" as="script"><link rel="prefetch" href="/assets/07-15.html-DYRGwrCw.js" as="script"><link rel="prefetch" href="/assets/07-16.html-C4Ofq7-B.js" as="script"><link rel="prefetch" href="/assets/09-03.html-Vn8qCanV.js" as="script"><link rel="prefetch" href="/assets/404.html-SNEMOls0.js" as="script"><link rel="prefetch" href="/assets/VocabularyAudio-Bl951W8W.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-5JF1eURm.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/images/logo.svg" alt="Notes"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Notes</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/ruancong/ruancong.github.io" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/ruancong/ruancong.github.io" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Docker <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h2 id="安装docker-engine-centos" tabindex="-1"><a class="header-anchor" href="#安装docker-engine-centos"><span>安装docker engine [CentOS]</span></a></h2><p><strong>卸载老版本的docker</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum remove <span class="token function">docker</span> <span class="token punctuation">\</span></span>
<span class="line">                  docker-client <span class="token punctuation">\</span></span>
<span class="line">                  docker-client-latest <span class="token punctuation">\</span></span>
<span class="line">                  docker-common <span class="token punctuation">\</span></span>
<span class="line">                  docker-latest <span class="token punctuation">\</span></span>
<span class="line">                  docker-latest-logrotate <span class="token punctuation">\</span></span>
<span class="line">                  docker-logrotate <span class="token punctuation">\</span></span>
<span class="line">                  docker-engine</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>和docker相关的内容存储在 <code>/var/lib/docker/</code>, 包括镜像（<code>images</code>）, 容器(<code>containers</code>), 卷(<code>volumes</code>）,网络(<code>networks</code>)等。 这些Docker相关的包统称为 <code>docker-ce</code></p><p><strong>使用repository安装</strong></p><p><strong>安装仓库</strong></p><ul><li>安装yum-utils (包含 <code>yum-config-manager</code>)<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li>安装 reposityory<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> yum-config-manager <span class="token punctuation">\</span></span>
<span class="line"> --add-repo <span class="token punctuation">\</span></span>
<span class="line"> https://download.docker.com/linux/centos/docker-ce.repo</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>安装docker engine</strong></p><ul><li><p>最新版本的安装</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io docker-compose-plugin</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>安装某个版本</p></li></ul><p>​ 查询版本号</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum list docker-ce <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="/assets/image-20220506153237978-BzCzLaF5.png" alt="image-20220506153237978"></p><p>例如：版本号就是 <code>docker-ce-18.09.1</code></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum <span class="token function">install</span> <span class="token punctuation">\</span></span>
<span class="line">docker-ce-<span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">&gt;</span> <span class="token punctuation">\</span></span>
<span class="line">docker-ce-cli-<span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">&gt;</span> <span class="token punctuation">\</span></span>
<span class="line">containerd.io <span class="token punctuation">\</span></span>
<span class="line">docker-compose-plugin</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>启动docker</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">sudo</span> systemctl start <span class="token function">docker</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Hello-world</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sudo</span> <span class="token function">docker</span> run hello-world</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><p><strong>将当前用户添加到docker组</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">docker</span> <span class="token environment constant">$USER</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="启动-docker-getting-started-教程" tabindex="-1"><a class="header-anchor" href="#启动-docker-getting-started-教程"><span>启动 docker/getting-started 教程</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 docker/getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>参数说明</p><ul><li><code>-d</code> - run the container in detached mode (in the background)</li><li><code>-p 80:80</code> - map port 80 of the host to port 80 in the container</li><li><code>docker/getting-started</code> - the image to use</li></ul><hr><h2 id="检查docker-daemon与版本" tabindex="-1"><a class="header-anchor" href="#检查docker-daemon与版本"><span>检查Docker daemon与版本</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> version</span>
<span class="line"><span class="token comment">###</span></span>
<span class="line"><span class="token function">docker</span> info</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="创建示例工程" tabindex="-1"><a class="header-anchor" href="#创建示例工程"><span>创建示例工程</span></a></h2><p><strong>代码编写</strong></p><p><span id="code">https://github.com/docker/getting-started/tree/master/app</span></p><p><strong>构建镜像</strong></p><ul><li>创建Dockerfile文件。Dockerfile文件不能有任何的后缀。（此例在package.json所在目录下创建Dockerfile文件）</li></ul><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># syntax=docker/dockerfile:1</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> node:12-alpine</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache python2 g++ make</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . .</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yarn install --production</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>, <span class="token string">&quot;src/index.js&quot;</span>]</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ <code>CMD</code> 命令表示当容器从镜像启动时运行的默认命令</p><ul><li>构建镜像</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> getting-started <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>​ <code>-t</code> flag tags our image； 最后的 . 表示Dockerfile文件所在的目录是当前目录</p><p><strong>启动容器</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-dp</span> <span class="token number">3000</span>:3000 getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>http://ip:3000 就可以启动应用了 （防火墙注意放开3000的端口号）</p><hr><h2 id="更新示例工程" tabindex="-1"><a class="header-anchor" href="#更新示例工程"><span>更新示例工程</span></a></h2><p><strong>更新代码</strong></p><p>...</p><p><strong>重新构建</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 可以在最后增加:tagName</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> getting-started <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>停止旧版本</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 查找正在运行的旧版本的container id</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">ps</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 停止旧版本</span></span>
<span class="line"><span class="token function">docker</span> stop <span class="token operator">&lt;</span>the-container-id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 删除旧版本</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>the-container-id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重新启动</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-dp</span> <span class="token number">3000</span>:3000 getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="重启策略" tabindex="-1"><a class="header-anchor" href="#重启策略"><span>重启策略</span></a></h2><p><code>docker run -it &lt;command&gt; --restart &lt;policy&gt;</code></p><p><code>&lt;policy&gt;</code> : 容器支持的重启策略包括always 、unless-stopped 和on- failed</p><blockquote><p>always 和unless-stopped 的最大区别，就是那些指定了--restartunless-stopped 并处于Stopped (Exited) 状态的容器，不会在Dockerdaemon重启的时候被重启</p></blockquote><h2 id="推送镜像到远程仓库" tabindex="-1"><a class="header-anchor" href="#推送镜像到远程仓库"><span>推送镜像到远程仓库</span></a></h2><ul><li><p>操作Docker Hub</p><ol><li>注册登陆 <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a>.</li><li>创建仓库，仓库名与需要推送的image名需要一致</li></ol></li><li><p>本地操作</p><ol><li>登陆上一步创建的账号</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> login <span class="token parameter variable">-u</span> YOUR-<span class="token environment constant">USER</span>-NAME</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li>确保image名字与上一步的仓库名一致，如果有需要可以重命名</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 其中 :TAG_NAME 可以省略，则为 latest</span></span>
<span class="line"><span class="token function">docker</span> tag getting-started YOUR-<span class="token environment constant">USER</span>-NAME/getting-started:TAG_NAME</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>推送</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> push YOUR-<span class="token environment constant">USER</span>-NAME/getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h2 id="在线运行镜像" tabindex="-1"><a class="header-anchor" href="#在线运行镜像"><span>在线运行镜像</span></a></h2><p>Open your browser to <a href="https://labs.play-with-docker.com/" target="_blank" rel="noopener noreferrer">Play with Docker</a>.</p><hr><h2 id="容器持久化数据" tabindex="-1"><a class="header-anchor" href="#容器持久化数据"><span>容器持久化数据</span></a></h2><h3 id="named-volumes" tabindex="-1"><a class="header-anchor" href="#named-volumes"><span><strong>Named Volumes</strong></span></a></h3><p>每个容器的文件是系统是相互独立的，即使是由同一个镜像启动的容器的文件也是相互隔离的。可以通过挂载volume 来实现</p><ol><li><p>创建volume</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> volume create todo-db</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>启动时挂载</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> run <span class="token parameter variable">-dp</span> <span class="token number">3000</span>:3000 <span class="token parameter variable">-v</span> todo-db:/etc/todos getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p>操作完以，重新停止，删除容器，用相同的命令启动docker时，数据就不会丢失。</p><p>查询volume挂载后，数据实际存在的位置</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> volume inspect todo-db</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="/assets/image-20220507113026889-CMZ_5J8D.png" alt="image-20220507113026889"></p><h3 id="bind-mounts" tabindex="-1"><a class="header-anchor" href="#bind-mounts"><span><strong>Bind Mounts</strong></span></a></h3><p>用的代码是上述<a href="#code">示例工程的代码</a></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-dp</span> <span class="token number">3000</span>:3000 <span class="token parameter variable">-w</span> /code/app <span class="token parameter variable">-v</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/code/app&quot;</span> node:12-alpine <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;yarn install &amp;&amp; yarn run dev&quot;</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-w</span> /app <span class="token parameter variable">-v</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/app&quot;</span> node:16-alpine <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;npm config set registry https://mirrors.huaweicloud.com/repository/npm/ &amp;&amp; npm install &amp;&amp; npm run build:testing&quot;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>-dp 3000:3000</code> - same as before. Run in detached (background) mode and create a port mapping</li><li><code>-w /app</code> - sets the “working directory” or the current directory that the command will run from</li><li><code>-v &quot;$(pwd):/app&quot;</code> - bind mount the current directory from the host in the container into the <code>/app</code> directory （主机地址与容器地址的映射关系<code>:</code>前是本机地址，<code>:</code>后是容器里的工作目录）</li><li><code>node:12-alpine</code> - the image to use. Note that this is the base image for our app from the Dockerfile</li><li><code>sh -c &quot;yarn install &amp;&amp; yarn run dev&quot;</code> - the command. We’re starting a shell using <code>sh</code> (alpine doesn’t have <code>bash</code>) and running <code>yarn install</code> to install <em>all</em> dependencies and then running <code>yarn run dev</code>. If we look in the <code>package.json</code>, we’ll see that the <code>dev</code> script is starting <code>nodemon</code>.</li></ul><hr><h2 id="docker-daemon日志" tabindex="-1"><a class="header-anchor" href="#docker-daemon日志"><span>Docker Daemon日志</span></a></h2><p>来查看docker daemon的日志</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">journalctl <span class="token parameter variable">-u</span> docker.service</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>还可以在docker的配置文件daemon.json中指定日志文件</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  &lt;Snip&gt;</span>
<span class="line">  <span class="token property">&quot;debug&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;log-level&quot;</span><span class="token operator">:</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  &lt;Snip&gt;</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="容器日志" tabindex="-1"><a class="header-anchor" href="#容器日志"><span>容器日志</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> logs <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>每个Docker主机也为容器提供了默认的日志驱动以及配置。其中包括json-file （默认）、journald （只在运行systemd 的Linux主机中生效）、syslog 、splunk 和gelf。</p><p>json-file 和journald 可能是较容易配置的，并且均可通过doker logs 和docker service logs 命令查看。其他日志驱动，可以通过第三方平台提供的原生工具进行查看。</p><p>配置其它的日志驱动：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;log-driver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;syslog&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以为某个容器或者服务配置单独的日志策略，只需在启动容器时指定日志驱动，这样就会覆盖daemon.json中的配置。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run --log-driver<span class="token operator">=</span>syslog <span class="token parameter variable">-d</span> nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="基于多个容器的app" tabindex="-1"><a class="header-anchor" href="#基于多个容器的app"><span>基于多个容器的app</span></a></h2><p>如果想把示例app的数据存储到mysql中。这时的app像这样。</p><p><img src="/assets/multi-app-architecture-CoBwtCpd.png" alt="Todo App connected to MySQL container"></p><p>因为容器之间是相互隔离的，两个容器之间要进行信息交互就得通过网络（两个容器需要在同一个网络一起）。There are two ways to put a container on a network: 1) Assign it at start or 2) connect an existing container.</p><p><strong>创建网络</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> network create todo-app</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>启动mysql</strong></p><p>启动mysql并连接到上一步创建的网络中</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span>  <span class="token parameter variable">--network</span> todo-app --network-alias mysql  <span class="token parameter variable">-v</span> todo-mysql-data:/var/lib/mysql  <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root   <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span>todos  mysql:5.7</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其中<code>--network</code> 表示运行的网络是 <code>todo-app</code></p><p>其中的 <code>--network-alias</code> 对网络起了一个别名，后续可以直接使用这个别名。</p><p>验证mysql是否启动成功</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>mysql-container-id<span class="token operator">&gt;</span> mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>寻找mysql容器的ip地址</strong></p><p>mysql容器已经运行起来了，怎么找到mysql容器的ip地址呢（每个容器都有它自己的ip地址）？</p><p>我们可以运用 <a href="https://github.com/nicolaka/netshoot" target="_blank" rel="noopener noreferrer">nicolaka/netshoot</a> 这个容器来寻址。</p><ul><li><p>启动netshoot</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--network</span> todo-app nicolaka/netshoot</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>进入容器后，可以使用 <code>dig</code> 这个命令来查询<code>mysql</code>的ip地址。(<code>dig</code>是一个很有用的DNS工具）</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">dig</span> mysql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>运行结果：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">;; ANSWER SECTION:</span>
<span class="line"> mysql.			600	IN	A	172.23.0.2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这条记录就是ip解析结果。虽然mysql不是一个正常的主机名，之所以能解析到是因为上一步的<code>--network-alias</code>设置了mysql。这使我们的app如果想连到mysql的话，这需要运用这个主机名<code>mysql</code>就可以。</p></li></ul><p><strong>启动基于mysql的app</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-dp</span> <span class="token number">3000</span>:3000 <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">-w</span> /app <span class="token parameter variable">-v</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/app&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">--network</span> todo-app <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_HOST</span><span class="token operator">=</span>mysql <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>root <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DB</span><span class="token operator">=</span>todos <span class="token punctuation">\</span></span>
<span class="line">   node:12-alpine <span class="token punctuation">\</span></span>
<span class="line">   <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;yarn install &amp;&amp; yarn run dev&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打开浏览器增加一些纪录时，这时候的数据会存到mysql中。</p><p>也可以直接启动上面章节构建的镜像</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-dp</span> <span class="token number">3000</span>:3000 <span class="token parameter variable">--network</span> todo-app <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_HOST</span><span class="token operator">=</span>mysql <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>root <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span>root  <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DB</span><span class="token operator">=</span>todos   getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="使用docker-compose启动app" tabindex="-1"><a class="header-anchor" href="#使用docker-compose启动app"><span>使用docker-compose启动app</span></a></h2><p><strong>安装docker-compose</strong></p><ul><li>下载可执行文件 <a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener noreferrer">release page</a></li><li>下载的文件重命名为docker-compose</li><li>移动到<code>/usr/bin/docker-compose</code>目录</li><li>赋予可执行权限 <code>chmod +x /usr/bin/docker-compose</code></li><li>验证版本号 <code>docker-compose version</code></li></ul><p><strong>创建docker-compose.yml文件</strong></p><ul><li><p>默认情况下，这个工程的名字是这个文件所在文件夹的名字</p></li><li><p>在项目的根目录下创建docker-compose.yml文件</p><blockquote><p>在最新版本中，Docker Compose relies on a YAML configuration file, usually named <code>compose.yaml</code>.</p></blockquote></li><li><p>Version top-level element (optional)，不同版本号的兼容情况可以查看<a href="https://docs.docker.com/compose/compose-file/compose-versioning/" target="_blank" rel="noopener noreferrer">compose version</a></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>这个<code>version</code> 只是起到提供信息的作用，并不会用相应的版本去检验docker-compose文件。</p></blockquote></li><li><p>为什用我本地的yaml文件启动docker compose时，再运行docker compose ls时，它会显示我的配置文件所在的地方，而用portainer启动stack时，再运行dokcer compose ls ,显示却没有了这个stack yaml文件的路径</p><blockquote><p>为了方便管理，docker compose 在创建容器、网络、卷等资源时，会自动为这些资源添加一系列的 Docker 标签。其中一个关键的标签是 com.docker.compose.project.config_files，它的值就是您本地配置文件的绝对路径。 Portainer 的自有管理机制：通过 Portainer 的 Web UI 部署一个 Stack 时，它不会添加 docker compose CLI 才会添加的那个 com.docker.compose.project.config_files 标签，因为它根本没有“文件”这个概念，只有“文本内容”</p></blockquote></li></ul><p>查看labels的方法：使用 docker inspect 命令查看该容器的所有信息。标签信息位于 Config.Labels 或 HostConfig.Labels 下</p><ul><li><p>Name top-level element</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment">### 定义项目的名称，不写的话，默认会以文件夹的名字相关的名字当作项目名。还可以${COMPOSE_PROJECT_NAME}变量来访问</span></span>
<span class="line"><span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&#39;my-app&#39;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>接下来定义启动app需要的不同的services (or containers)</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>定义自己应用的 service</strong></p><ul><li><p>定义第一个service名字(app)和镜像，其中service名字任意取，这个名字会自动成为一个network alias。这对我们定义mysql服务很有效</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>通常来说，紧接着image下面会设置command，但是对它们出现的先后顺序并没有要求</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine</span>
<span class="line">     <span class="token key atrule">command</span><span class="token punctuation">:</span> sh <span class="token punctuation">-</span>c &quot;yarn install <span class="token important">&amp;&amp;</span> yarn run dev&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>设置端口号，设置端口号有两种方式：一种是<a href="https://docs.docker.com/compose/compose-file/compose-file-v3/#short-syntax-1" target="_blank" rel="noopener noreferrer">短语法</a>；一种是<a href="https://docs.docker.com/compose/compose-file/compose-file-v3/#long-syntax-1" target="_blank" rel="noopener noreferrer">长语法</a></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine</span>
<span class="line">     <span class="token key atrule">command</span><span class="token punctuation">:</span> sh <span class="token punctuation">-</span>c &quot;yarn install <span class="token important">&amp;&amp;</span> yarn run dev&quot;</span>
<span class="line">     <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定义工作目录与volume ,volume的定义也有两种方式：<a href="https://docs.docker.com/compose/compose-file/compose-file-v3/#short-syntax-3" target="_blank" rel="noopener noreferrer">short</a> 和 <a href="https://docs.docker.com/compose/compose-file/compose-file-v3/#long-syntax-3" target="_blank" rel="noopener noreferrer">long</a>。在这里定义volumes时可以直接运用相对路径</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine</span>
<span class="line">     <span class="token key atrule">command</span><span class="token punctuation">:</span> sh <span class="token punctuation">-</span>c &quot;yarn install <span class="token important">&amp;&amp;</span> yarn run dev&quot;</span>
<span class="line">     <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span></span>
<span class="line">     <span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /app</span>
<span class="line">     <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> ./<span class="token punctuation">:</span>/app</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定义镜像的环境变量</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine</span>
<span class="line">     <span class="token key atrule">command</span><span class="token punctuation">:</span> sh <span class="token punctuation">-</span>c &quot;yarn install <span class="token important">&amp;&amp;</span> yarn run dev&quot;</span>
<span class="line">     <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span></span>
<span class="line">     <span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /app</span>
<span class="line">     <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> ./<span class="token punctuation">:</span>/app</span>
<span class="line">     <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token key atrule">MYSQL_HOST</span><span class="token punctuation">:</span> mysql</span>
<span class="line">       <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> root</span>
<span class="line">       <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> root</span>
<span class="line">       <span class="token key atrule">MYSQL_DB</span><span class="token punctuation">:</span> todos</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>定义mysql service</strong></p><ul><li><p>将mysql service 服务命名为mysql，这样自动生成的network alias也是mysql；指定mysql服务的镜像为mysql:5.7</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token comment"># The app service definition</span></span>
<span class="line">   <span class="token key atrule">mysql</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定义mysql service 的named volumes。</p><p>基于Compose的volumes并不像使用docker run 会自动创建named volumes。当在使用Compose时需要在配置文件顶层中申明<code>volumes: </code>。而在具体的服务下的<code>volumes: </code>是用来指定这个服务的挂载点的。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token comment"># The app service definition</span></span>
<span class="line">   <span class="token key atrule">mysql</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span></span>
<span class="line">     <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> todo<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql</span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">todo-mysql-data</span><span class="token punctuation">:</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定义mysql的环境变量</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"> <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token comment"># The app service definition</span></span>
<span class="line">   <span class="token key atrule">mysql</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span></span>
<span class="line">     <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> todo<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql</span>
<span class="line">     <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> secret</span>
<span class="line">       <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> todos</span>
<span class="line"></span>
<span class="line"> <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token key atrule">todo-mysql-data</span><span class="token punctuation">:</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>完整的docker-compose.yml文件</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.7&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine</span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span> sh <span class="token punctuation">-</span>c &quot;yarn install <span class="token important">&amp;&amp;</span> yarn run dev&quot;</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span></span>
<span class="line">    <span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /app</span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./<span class="token punctuation">:</span>/app</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">MYSQL_HOST</span><span class="token punctuation">:</span> mysql</span>
<span class="line">      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> root</span>
<span class="line">      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> secret</span>
<span class="line">      <span class="token key atrule">MYSQL_DB</span><span class="token punctuation">:</span> todos</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">mysql</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> todo<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root</span>
<span class="line">      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> todos</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">todo-mysql-data</span><span class="token punctuation">:</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="使用docker-compose关闭app" tabindex="-1"><a class="header-anchor" href="#使用docker-compose关闭app"><span>使用docker-compose关闭app</span></a></h2><p>进入docker-compose.yml文件所在的目录，运行</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker-compose</span> down</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>默认情况下容器(containers)与网络(network)会被停止与删除。但是创建的volumes不会被删除，如果想要删除的话加入<code>--volumes</code>参数。</p><p>后台运行</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker-compose</span> up d</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>停止compse里的某一个应用</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker-compose</span> stop xiaozhi</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>启动【升级】某一个应用</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker-compose up -d xiaozhi</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>up 是升级启动一个服务，start只是启动一个服务，并不升级</p></blockquote><h2 id="docker-compose-启动中间件" tabindex="-1"><a class="header-anchor" href="#docker-compose-启动中间件"><span>docker-compose 启动中间件</span></a></h2><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&#39;middleware-services&#39;</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">mysql</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>  <span class="token comment"># 使用MySQL 5.7的官方镜像</span></span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root  <span class="token comment"># 设置MySQL的root用户的密码</span></span>
<span class="line">      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> xiaozhi_health_cloud  <span class="token comment"># 创建一个初始数据库</span></span>
<span class="line">      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> Asia/Shanghai  <span class="token comment"># 设置时区</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> xiaozhi<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql  <span class="token comment"># 数据持久化到命名卷</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;3306:3306&quot;</span>  <span class="token comment"># 将容器的3306端口映射到宿主机的3306端口</span></span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5.0.14</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;6379:6379&quot;</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./redis<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/data</span>
<span class="line">      <span class="token punctuation">-</span> ./redis<span class="token punctuation">-</span>conf<span class="token punctuation">:</span>/etc/redis</span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass root</span>
<span class="line">  <span class="token key atrule">emqx</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> emqx/emqx<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> 1883<span class="token punctuation">:</span><span class="token number">1883</span>   <span class="token comment"># MQTT 协议端口</span></span>
<span class="line">      <span class="token punctuation">-</span> 8084<span class="token punctuation">:</span><span class="token number">8081</span>   <span class="token comment"># Dashboard 管理界面端口</span></span>
<span class="line">      <span class="token punctuation">-</span> 8083<span class="token punctuation">:</span><span class="token number">8083</span>   <span class="token comment"># WebSocket 端口</span></span>
<span class="line">      <span class="token punctuation">-</span> 8883<span class="token punctuation">:</span><span class="token number">8883</span>   <span class="token comment"># MQTT SSL 端口</span></span>
<span class="line">      <span class="token punctuation">-</span> 18083<span class="token punctuation">:</span><span class="token number">18083</span> <span class="token comment"># Dashboard HTTP API 端口</span></span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">:</span>3.13<span class="token punctuation">-</span>management</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;5672:5672&quot;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;15672:15672&quot;</span></span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">RABBITMQ_DEFAULT_USER</span><span class="token punctuation">:</span> admin</span>
<span class="line">      <span class="token key atrule">RABBITMQ_DEFAULT_PASS</span><span class="token punctuation">:</span> admin</span>
<span class="line"><span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">xiaozhi-mysql-data</span><span class="token punctuation">:</span>  <span class="token comment"># 定义一个用于持久化数据的卷</span></span>
<span class="line">  <span class="token key atrule">redis-data</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>mysql 默认字符，表名不区分大小写</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#39;3.1&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">mysql</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span></span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4 <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_general_ci</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root</span>
<span class="line">      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> area_oa</span>
<span class="line">      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> Asia/Shanghai</span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> local<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql</span>
<span class="line">      <span class="token punctuation">-</span> ./mycustom.cnf<span class="token punctuation">:</span>/etc/mysql/conf.d/custom.cnf</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;3306:3306&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">local-mysql-data</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>[mysqld] lower_case_table_names=1</p></blockquote><h2 id="docker-启动nexus" tabindex="-1"><a class="header-anchor" href="#docker-启动nexus"><span>docker 启动nexus</span></a></h2><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">nexus</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> sonatype/nexus3</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&#39;8081:8081&#39;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&#39;18081:18081&#39;</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&#39;./nexus-data:/nexus-data&#39;</span></span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="构建镜像的最佳实践" tabindex="-1"><a class="header-anchor" href="#构建镜像的最佳实践"><span>构建镜像的最佳实践</span></a></h2><p><strong>安全扫描</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> scan getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>镜像分层查看</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> image <span class="token function">history</span> getting-started</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>使镜像大小尽量小</strong></p><ul><li><p>选用合适的base image.</p><blockquote><p>If you need a JDK, consider basing your image on the official <code>openjdk</code> image, rather than starting with a generic <code>ubuntu</code> image and installing <code>openjdk</code> as part of the Dockerfile.</p></blockquote></li><li><p>分层缓存，某层没有发生变化是，会运用到缓存。只要某一层发生变化，这层的下面部分层次就会重新创建</p></li><li><p>可以新建 .dockerignore 里面存放不复制到镜像里的文件</p></li><li><p>分多阶段构建</p><blockquote><ul><li>Separate build-time dependencies from runtime dependencies</li></ul><ul><li><p>Reduce overall image size by shipping <em>only</em> what your app needs to run</p><p>例如:</p></li></ul><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># syntax=docker/dockerfile:1</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> node:16.14.2 <span class="token keyword">AS</span> build</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> package* yarn.lock ./</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yarn install</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . .</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yarn run build</span></span>
<span class="line"></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> nginx:alpine</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/dist /usr/share/nginx/html</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><blockquote><p>java的例子</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> eclipse-temurin:21.0.2_13-jdk-jammy <span class="token keyword">as</span> builder</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /opt/app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> .mvn/ .mvn</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> mvnw pom.xml ./</span></span>
<span class="line"><span class="token comment">## 先安装包到本地</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> ./mvnw dependency:go-offline</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> ./src ./src</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> ./mvnw clean install </span></span>
<span class="line"></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> eclipse-temurin:21.0.2_13-jre-jammy <span class="token keyword">as</span> final</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /opt/app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 8080</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /opt/app/target/*.jar /opt/app/*.jar</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;java&quot;</span>, <span class="token string">&quot;-jar&quot;</span>, <span class="token string">&quot;/opt/app/*.jar&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li><li><p>如果没有使用到多阶段构建，为了能够减少镜像的层数，尽量减少 <code>RUN</code> 命令的行数，可以考虑将多个命令合并到一行</p><blockquote><p>例如：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get -y update</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get install -y python</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get -y update &amp;&amp; apt-get install -y python</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></blockquote></li><li><p>如果自己的创建的镜像有很多相似之处，可以创建自己的base image，其它的基于这个base image构建</p></li></ul><p><strong>镜像tag</strong></p><p>一次可以打多个标签</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> tag node-docker:latest node-docker:v1.0.0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>镜像的:latest 并不一定是镜像最新的版本</p><p><strong>如何持久化应用数据</strong></p><ul><li>避免将应用数据存入容器中，这样会使容器大小不断增加；降低I/O效率；</li><li>存储数据用volumes</li><li>One case where it is appropriate to use <a href="https://docs.docker.com/storage/bind-mounts/" target="_blank" rel="noopener noreferrer">bind mounts</a> is during development, when you may want to mount your source directory or a binary you just built into your container. For production, use a volume instead, mounting it into the same location as you mounted a bind mount during development.</li><li>For production, use <a href="https://docs.docker.com/engine/swarm/secrets/" target="_blank" rel="noopener noreferrer">secrets</a> to store sensitive application data used by services, and use <a href="https://docs.docker.com/engine/swarm/configs/" target="_blank" rel="noopener noreferrer">configs</a> for non-sensitive data such as configuration files.</li></ul><p><strong>build缓存</strong></p><p>利用dockerfile在构建应用时，<code>RUN --mount=type=cache,target=/root/.m2/repository ./mvnw clean package -DskipTests -B</code> , 当cached后，怎么主动清除这个caches</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> builder prune</span>
<span class="line"><span class="token comment">#清除所有缓存（包括活动的）：</span></span>
<span class="line"><span class="token function">docker</span> builder prune <span class="token parameter variable">-a</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="镜像相关" tabindex="-1"><a class="header-anchor" href="#镜像相关"><span>镜像相关</span></a></h2><p>悬虚(dangling)镜像： 没有标签的镜像。</p><p>当构建一个新的镜像的tag,是一个已经存在的tag，就会使老的旧镜像变成悬虚镜像</p><p><strong>单步骤构建</strong></p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> node:16.14.2</span></span>
<span class="line"></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\</span></span>
<span class="line">    apt-get install -y nginx &amp;&amp; <span class="token operator">\</span></span>
<span class="line">    rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> package.json ./</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> npm config set registry https://mirrors.huaweicloud.com/repository/npm/ &amp;&amp; <span class="token operator">\</span></span>
<span class="line">    npm install</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . . </span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> npm run build &amp;&amp; <span class="token operator">\</span></span>
<span class="line">    rm -f /etc/nginx/conf.d/default.conf &amp;&amp; <span class="token operator">\</span></span>
<span class="line">    cp default.conf /etc/nginx/conf.d/ &amp;&amp; <span class="token operator">\</span></span>
<span class="line">    rm -rf /usr/share/nginx/html/* </span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> cp -r dist/* /usr/share/nginx/html/</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;nginx&quot;</span>, <span class="token string">&quot;-g&quot;</span>, <span class="token string">&quot;daemon off;&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="dockerfile-最佳实践" tabindex="-1"><a class="header-anchor" href="#dockerfile-最佳实践"><span>Dockerfile 最佳实践</span></a></h2><p><strong>build context</strong></p><p>运行<code>docker build</code>命令的当前目录，默认情况下Dockerfile文件应该就在此目录下，也可以使用<code>-f</code> 参数来指定Dockerfile文件的位置，该目录及子目录都会被发送到Docker的daemon 来作为构建的上下文。</p><p>例1：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">mkdir</span> myproject <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> myproject</span>
<span class="line">$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello&quot;</span> <span class="token operator">&gt;</span> hello</span>
<span class="line">$ <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;FROM busybox<span class="token entity" title="\n">\n</span>COPY /hello /<span class="token entity" title="\n">\n</span>RUN cat /hello&quot;</span> <span class="token operator">&gt;</span> Dockerfile</span>
<span class="line">$ <span class="token function">docker</span> build <span class="token parameter variable">-t</span> helloapp:v1 <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述的Dockerfile所在的当前目录<code>.</code>就是build context。</p><p>例2：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> dockerfiles context</span>
<span class="line">$ <span class="token function">mv</span> Dockerfile dockerfiles <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> hello context</span>
<span class="line">$ <span class="token function">docker</span> build --no-cache <span class="token parameter variable">-t</span> helloapp:v2 <span class="token parameter variable">-f</span> dockerfiles/Dockerfile context</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述的Dockerfile所在的目录是<code>dockerfiles</code>，<code>context</code>是build context。</p><p><strong>Pipe Dockerfile through <code>stdin</code></strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;FROM busybox\nRUN echo &quot;hello world&quot;&#39;</span> <span class="token operator">|</span> <span class="token function">docker</span> build -</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build -<span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">FROM busybox</span>
<span class="line">RUN echo &quot;hello world&quot;</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Build an image using a Dockerfile from stdin, without sending build context</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> -</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>The hyphen (<code>-</code>) takes the position of the <code>PATH</code>. 将不会发送build context 到 docker daemon.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> myimage:latest -<span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">FROM busybox</span>
<span class="line">RUN echo &quot;hello world&quot;</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果用这种方式，<code>COPY</code> <strong>or</strong> <code>ADD</code>不可使用，会发生异常</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># create a directory to work in</span></span>
<span class="line"><span class="token function">mkdir</span> example</span>
<span class="line"><span class="token builtin class-name">cd</span> example</span>
<span class="line"></span>
<span class="line"><span class="token comment"># create an example file</span></span>
<span class="line"><span class="token function">touch</span> somefile.txt</span>
<span class="line"></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> myimage:latest -<span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">FROM busybox</span>
<span class="line">COPY somefile.txt ./</span>
<span class="line">RUN cat /somefile.txt</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># observe that the build fails</span></span>
<span class="line"><span class="token punctuation">..</span>.</span>
<span class="line">Step <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> COPY somefile.txt ./</span>
<span class="line">COPY failed: <span class="token function">stat</span> /var/lib/docker/tmp/docker-builder249218248/somefile.txt: no such <span class="token function">file</span> or directory</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Build from a local build context, using a Dockerfile from stdin</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> -f- <span class="token environment constant">PATH</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># create a directory to work in</span></span>
<span class="line"><span class="token function">mkdir</span> example</span>
<span class="line"><span class="token builtin class-name">cd</span> example</span>
<span class="line"></span>
<span class="line"><span class="token comment"># create an example file</span></span>
<span class="line"><span class="token function">touch</span> somefile.txt</span>
<span class="line"></span>
<span class="line"><span class="token comment"># build an image using the current directory as context, and a Dockerfile passed through stdin</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> myimage:latest -f- <span class="token builtin class-name">.</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">FROM busybox</span>
<span class="line">COPY somefile.txt ./</span>
<span class="line">RUN cat /somefile.txt</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Build from a remote build context, using a Dockerfile from stdin</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> -f- <span class="token environment constant">PATH</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> myimage:latest -f- https://github.com/docker-library/hello-world.git <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">FROM busybox</span>
<span class="line">COPY hello.c ./</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>When building an image using a remote Git repository as build context, Docker performs a <code>git clone</code> of the repository on the local machine, and sends those files as build context to the daemon. This feature requires <code>git</code> to be installed on the host where you run the <code>docker build</code> command.</p></blockquote><p><strong>Exclude with .dockerignore</strong></p><p>将在build context内但不想发送到daemon 的文件可写在<code>.dockerignore</code>文件内</p><p>This file supports exclusion patterns similar to <code>.gitignore</code> files. For information on creating one, see the <a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" target="_blank" rel="noopener noreferrer">.dockerignore file</a>.</p><p><strong>Minimize the number of layers</strong></p><p>In older versions of Docker, it was important that you minimized the number of layers in your images to ensure they were performant. The following features were added to reduce this limitation:</p><ul><li>Only the instructions <code>RUN</code>, <code>COPY</code>, <code>ADD</code> create layers. Other instructions create temporary intermediate images, and do not increase the size of the build.</li><li>Where possible, use <a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener noreferrer">multi-stage builds</a>, and only copy the artifacts you need into the final image. This allows you to include tools and debug information in your intermediate build stages without increasing the size of the final image.</li></ul><p><strong>Sort multi-line arguments</strong></p><p>Whenever possible, ease later changes by sorting multi-line arguments alphanumerically. （按字母顺序将命令排序）</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">RUN <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token punctuation">\</span></span>
<span class="line">  bzr <span class="token punctuation">\</span></span>
<span class="line">  cvs <span class="token punctuation">\</span></span>
<span class="line">  <span class="token function">git</span> <span class="token punctuation">\</span></span>
<span class="line">  mercurial <span class="token punctuation">\</span></span>
<span class="line">  subversion <span class="token punctuation">\</span></span>
<span class="line">  <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/apt/lists/*</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="dockerfile-instructions" tabindex="-1"><a class="header-anchor" href="#dockerfile-instructions"><span>Dockerfile instructions</span></a></h2><p><strong>FROM</strong></p><p>Whenever possible, use current official images as the basis for your images.</p><p><strong>LABEL</strong></p><p>For each label, add a line beginning with <code>LABEL</code> and with one or more key-value pairs.</p><blockquote><p>Strings with spaces must be quoted <strong>or</strong> the spaces must be escaped. Inner quote characters (<code>&quot;</code>), must also be escaped.</p></blockquote><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># Set one or more individual labels</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> com.example.version=<span class="token string">&quot;0.0.1-beta&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> vendor1=<span class="token string">&quot;ACME Incorporated&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> vendor2=ZENITH\ Incorporated</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> com.example.release-date=<span class="token string">&quot;2015-02-12&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> com.example.version.is-production=<span class="token string">&quot;&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>An image can have more than one label. Prior to Docker 1.10, it was recommended to combine all labels into a single <code>LABEL</code> instruction, to prevent extra layers from being created. This is no longer necessary, but combining labels is still supported.</p></blockquote><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># Set multiple labels on one line</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> com.example.version=<span class="token string">&quot;0.0.1-beta&quot;</span> com.example.release-date=<span class="token string">&quot;2015-02-12&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>The above can also be written as:</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># Set multiple labels at once, using line-continuation characters to break long lines</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> vendor=ACME\ Incorporated <span class="token operator">\</span></span>
<span class="line">      com.example.is-beta= <span class="token operator">\</span></span>
<span class="line">      com.example.is-production=<span class="token string">&quot;&quot;</span> <span class="token operator">\</span></span>
<span class="line">      com.example.version=<span class="token string">&quot;0.0.1-beta&quot;</span> <span class="token operator">\</span></span>
<span class="line">      com.example.release-date=<span class="token string">&quot;2015-02-12&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RUN</strong></p><p>使用<code>\</code>把命令分成多行，便于阅读管理。RUN命令有些陷阱的地方</p><p><strong>apt-get</strong></p><p>Always combine <code>RUN apt-get update</code> with <code>apt-get install</code> in the same <code>RUN</code> statement.</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span></span>
<span class="line">    package-bar <span class="token operator">\</span></span>
<span class="line">    package-baz <span class="token operator">\</span></span>
<span class="line">    package-foo  <span class="token operator">\</span></span>
<span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果分开使用，会导致缓存问题。这使得<code>install </code>命令安装的软件可能是过期的问题。解决这个问题，要么像上面一样把这两个命令联合使用，要么指定<code>package</code>的版本号。如：<code>package-foo=1.3.*</code>。</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># syntax=docker/dockerfile:1</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:18.04</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get install -y curl nginx</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Below is a well-formed <code>RUN</code> instruction that demonstrates all the <code>apt-get</code> recommendations.</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span></span>
<span class="line">    aufs-tools <span class="token operator">\</span></span>
<span class="line">    automake <span class="token operator">\</span></span>
<span class="line">    build-essential <span class="token operator">\</span></span>
<span class="line">    curl <span class="token operator">\</span></span>
<span class="line">    dpkg-sig <span class="token operator">\</span></span>
<span class="line">    libcap-dev <span class="token operator">\</span></span>
<span class="line">    libsqlite3-dev <span class="token operator">\</span></span>
<span class="line">    mercurial <span class="token operator">\</span></span>
<span class="line">    reprepro <span class="token operator">\</span></span>
<span class="line">    ruby1.9.1 <span class="token operator">\</span></span>
<span class="line">    ruby1.9.1-dev <span class="token operator">\</span></span>
<span class="line">    s3cmd=1.1.* <span class="token operator">\</span></span>
<span class="line"> &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Using pipes</strong></p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> wget -O - https://some.site | wc -l &gt; /number</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>上述命令只需要 <code>wc -l &gt; /number</code>运行成功就能成功构建镜像，而不管<code>wget -O - https://some.sit</code> 是否成功与否。如果想要其中一个失败了，就阻止构建，可加命令<code>set -o pipefail &amp;&amp;</code> 。例如：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> set -o pipefail &amp;&amp; wget -O - https://some.site | wc -l &gt; /number</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p><strong>Not all shells support the</strong> <code>-o pipefail</code> <strong>option.</strong></p><p>In cases such as the <code>dash</code> shell on Debian-based images, consider using the <em>exec</em> form of <code>RUN</code> to explicitly choose a shell that does support the <code>pipefail</code> option. For example:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">RUN [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;set -o pipefail &amp;&amp; wget -O - https://some.site | wc -l &gt; /number&quot;]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></blockquote><p><strong>CMD</strong></p><p>The <code>CMD</code> instruction should be used to run the software contained in your image, along with any arguments.</p><p><code>CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;…]</code>. Thus, if the image is for a service, such as Apache and Rails, you would run something like <code>CMD [&quot;apache2&quot;,&quot;-DFOREGROUND&quot;]</code>. Indeed, this form of the instruction is recommended for any service-based image.</p><p><code>CMD</code> should rarely be used in the manner of <code>CMD [&quot;param&quot;, &quot;param&quot;]</code> in conjunction with <a href="https://docs.docker.com/engine/reference/builder/#entrypoint" target="_blank" rel="noopener noreferrer"><code>ENTRYPOINT</code></a>, unless you and your expected users are already quite familiar with how <code>ENTRYPOINT</code> works.</p><p><strong>EXPOSE</strong></p><p>For example, an image containing the Apache web server would use <code>EXPOSE 80</code>, while an image containing MongoDB would use <code>EXPOSE 27017</code> and so on.</p><p><strong>ENV</strong></p><p>You can use <code>ENV</code> to update the <code>PATH</code> environment variable for the software your container installs. For example, <code>ENV PATH=/usr/local/nginx/bin:$PATH</code> ensures that <code>CMD [&quot;nginx&quot;]</code> just works.</p><p>也可以简单地用于申明变量</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ENV</span> PG_MAJOR=9.3</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> PG_VERSION=9.3.4</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> curl -SL https://example.com/postgres-<span class="token variable">$PG_VERSION</span>.tar.xz | tar -xJC /usr/src/postgres &amp;&amp; …</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> PATH=/usr/local/postgres-<span class="token variable">$PG_MAJOR</span>/bin:<span class="token variable">$PATH</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每一行的<code>ENV</code> 会创建一个中间层，即使在下面的层<code>unset </code>了这个变量，这个变量也一直存在。</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># syntax=docker/dockerfile:1</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> alpine</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> ADMIN_USER=<span class="token string">&quot;mark&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> echo <span class="token variable">$ADMIN_USER</span> &gt; ./mark</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> unset ADMIN_USER</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token builtin class-name">test</span> <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&#39;echo $ADMIN_USER&#39;</span> <span class="token comment">## 将输出mark</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>为了能够正确删除这个变量，<code>set</code>, <code>use</code>, and <code>unset</code>放在同一层。You can separate your commands with <code>;</code> or <code>&amp;&amp;</code>。 If you use <code>&amp;&amp;</code>, and one of the commands fails, the <code>docker build</code> also fails.</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># syntax=docker/dockerfile:1</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> alpine</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> export ADMIN_USER=<span class="token string">&quot;mark&quot;</span> <span class="token operator">\</span></span>
<span class="line">    &amp;&amp; echo <span class="token variable">$ADMIN_USER</span> &gt; ./mark <span class="token operator">\</span></span>
<span class="line">    &amp;&amp; unset ADMIN_USER</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> sh</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token builtin class-name">test</span> <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&#39;echo $ADMIN_USER&#39;</span>  <span class="token comment">## 将不会输出什么</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>ENV vs ARG</strong></p><p>Dockerfile 中的 ARG 和 ENV 变量,主要的区别有:</p><ul><li>ARG 是构建参数,只在构建 imagen 阶段有效。构建完成后,ARG 设置的值不会保留在镜像中。</li><li>ENV 是环境变量,它可以在构建阶段和运行阶段使用。ENV 设置的值会被保留在镜像中,以便在容器启动时使用。</li><li>ARG 的值可以在构建过程中通过 docker build 使用 --build-arg 来覆盖,而 ENV 的值如果在构建过程中被 --build-arg 覆盖,那只在构建过程生效,不会对最终镜像产生影响。</li><li>在 Dockerfile 中,ENV 可以引用 ARG 设置的值,但 ARG 不能引用 ENV 的值。</li><li>在构建过程中,ARG 的默认值可以没有,但 ENV 的默认值必须有。</li></ul><p>例子：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># 构建参数</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ARG</span> VERSION=latest</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ARG</span> DEBUG=off</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 构建镜像</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> nginx:<span class="token variable">$VERSION</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 环境变量  </span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> APP_HOME /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> DEBUG <span class="token variable">$DEBUG</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 将代码复制到镜像中</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . <span class="token variable">$APP_HOME</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 暴露端口</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动命令</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;nginx&quot;</span>, <span class="token string">&quot;-g&quot;</span>, <span class="token string">&quot;daemon off;&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构建：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build --build-arg <span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token number">1.19</span>.8 <span class="token parameter variable">-t</span> myimage <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>ADD or COPY</strong></p><p><code>ADD</code>与<code>COPY</code>的功能基本相同，但首选<code>COPY</code>. <code>COPY</code> 只有简单的复制文件或文件夹到镜像的功能，<code>ADD</code>除些之外，还有自动解压tar文件，与下载远程文件的功能。除了你需要用到这些特性的情况下才使用<code>ADD</code>,不然一般都是选用<code>COPY</code>.</p><p>虽然 ADD 命令有时会自动处理权限，但 COPY 不会。为了确保你的 entrypoint.sh 脚本一定能被执行，最好在 Dockerfile 里显式地给它加上执行权限。</p><p><span style="color:red;"><strong>不鼓励</strong></span>这个使用：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ADD</span> https://example.com/big.tar.xz /usr/src/things/</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> make -C /usr/src/things all</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用这个取代</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /usr/src/things <span class="token operator">\</span></span>
<span class="line">    &amp;&amp; curl -SL https://example.com/big.tar.xz <span class="token operator">\</span></span>
<span class="line">    | tar -xJC /usr/src/things <span class="token operator">\</span></span>
<span class="line">    &amp;&amp; make -C /usr/src/things all</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ENTRYPOINT</strong></p><p>The best use for <code>ENTRYPOINT</code> is to set the image’s main command, allowing that image to be run as though it was that command (and then use <code>CMD</code> as the default flags). <code>ENTRYPOINT</code>的值将做为主命令，<code>CMD</code> 的值将做为参数传入</p><p>example:</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;s3cmd&quot;</span>]</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;--help&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>还可以运行脚本文件，创建<code>docker-entrypoint.sh</code>文件</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&#39;postgres&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token function">chown</span> <span class="token parameter variable">-R</span> postgres <span class="token string">&quot;<span class="token variable">$PGDATA</span>&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> <span class="token parameter variable">-A</span> <span class="token string">&quot;<span class="token variable">$PGDATA</span>&quot;</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        gosu postgres initdb</span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line">    <span class="token builtin class-name">exec</span> gosu postgres <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">COPY</span> ./docker-entrypoint.sh /</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;/docker-entrypoint.sh&quot;</span>]</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;postgres&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以简单地运行镜像</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> run postgres</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 这个命令中最后的 postgres --help 将被当作参数传入docker-entrypoint.sh脚本中</span></span>
<span class="line"><span class="token function">docker</span> run postgres postgres <span class="token parameter variable">--help</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## bash 将被当作参数传入docker-entrypoint.sh脚本中</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> postgres <span class="token function">bash</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>VOLUME</strong></p><p>The <code>VOLUME</code> instruction should be used to expose any database storage area, configuration storage, or files/folders created by your docker container. You are strongly encouraged to use <code>VOLUME</code> for any mutable and/or user-serviceable parts of your image.</p><p><strong>WORKDIR</strong></p><p>For clarity and reliability, you should always use absolute paths for your <code>WORKDIR</code>. Also, you should use <code>WORKDIR</code> instead of proliferating instructions like <code>RUN cd … &amp;&amp; do-something</code>, which are hard to read, troubleshoot, and maintain.</p><p><strong>ONBUILD</strong></p><h2 id="build-images-with-buildkit" tabindex="-1"><a class="header-anchor" href="#build-images-with-buildkit"><span>Build images with BuildKit</span></a></h2><p><strong>To enable BuildKit builds</strong></p><p>最新版本已经默认开启</p><p>Easiest way from a fresh install of docker is to set the <code>DOCKER_BUILDKIT=1</code> environment variable when invoking the <code>docker build</code> command, such as:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token function">docker</span> build <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>To enable docker BuildKit by default, set daemon configuration in <code>/etc/docker/daemon.json</code> feature to true and restart the daemon:</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;features&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;buildkit&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="运行镜像" tabindex="-1"><a class="header-anchor" href="#运行镜像"><span>运行镜像</span></a></h2><p>-p (--publish); --name 命令容器名字</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker run -d -p 8000:8000 --name rest-server node-docker</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="部署tomcat应用" tabindex="-1"><a class="header-anchor" href="#部署tomcat应用"><span>部署tomcat应用</span></a></h2><p>tomcat:9 和 tomcat:9-jdk8 这两个镜像的区别在于:- tomcat:9:只包含 Tomcat 9,没有包含 JDK。 tomcat:9-jdk8:包含 Tomcat 9 和 JDK 8,可以直接运行 Java 应用。所以,如果你的应用是:1. 纯 Tomcat 应用,不依赖 JDK,可以使用 tomcat:9 。这是一个更轻量的镜像,体积更小。2. 基于 Java 的应用,需要 JDK 运行环境,应选择 tomcat:9-jdk8。这个镜像直接内置了 JDK,十分方便。</p><h2 id="配置http的docker-register" tabindex="-1"><a class="header-anchor" href="#配置http的docker-register"><span>配置http的docker register</span></a></h2><p>在<code>/etc/docker/daemon.json</code>配置</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;insecure-registries&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;leite-dev:8081&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nexus-配置成私有docker-register" tabindex="-1"><a class="header-anchor" href="#nexus-配置成私有docker-register"><span>Nexus 配置成私有docker register</span></a></h2><p>在Nexus上配置私有的Docker registry主要涉及到在Nexus端创建存储库，并在Docker端进行相应的配置以便能够推送和拉取镜像。以下是详细步骤：</p><p><strong>Nexus端配置</strong></p><ol><li><p><strong>启动Nexus</strong>: 使用Docker运行Nexus的命令如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--net</span> <span class="token function">host</span> <span class="token parameter variable">--name</span> nexus sonatype/nexus3</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>启动后，可以通过<code>http://localhost:8081</code>访问Nexus界面。</p></li><li><p><strong>创建Docker repository</strong>: 登录Nexus后，找到创建repository的选项，选择<code>docker (hosted)</code>类型，输入名称和HTTP端口【如：18081】地址【后续docker login要用这个端口】。</p><blockquote><p>A configured context-path for the user interface does not affect the repository connector URLs used by Docker. E.g. if your repository manager instance is configured to be available at <code>http://localhost:8081/nexus</code> instead of the default root context <code>http://localhost:8081/</code>, the URLs for your Docker repositories will still only use the configured port for the repository and omit the context path in the URL. This is a side-effect of the the fact that Docker does not support context paths in the registry API.</p></blockquote></li><li><p><strong>配置代理Docker repository</strong> (如果需要): 由于安全原因，Docker push/pull时必须使用HTTPS协议。可以选择使用Nginx代理Nexus构建的Docker repository，配置SSL证书。</p><blockquote><p>不然的话，增加这个配置</p><p>在<code>/etc/docker/daemon.json</code>配置</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;insecure-registries&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;leite-dev:8081&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>systemctl daemon-reload; systemctl restart docker</code></p></blockquote></li><li><p><strong>需要将18081透露出来</strong></p></li></ol><p><strong>Docker端配置</strong></p><ol><li><p><strong>处理自签名证书问题</strong>【http时忽略此步骤】: 如果使用自签名证书，Docker客户端默认不会信任它。解决方法是将证书添加到Docker的信任列表中：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker/certs.d/your-nexus-domain:port</span>
<span class="line"><span class="token function">cp</span> your-nexus-domain.crt /etc/docker/certs.d/your-nexus-domain:port/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>登录Nexus Docker registry</strong>: 使用<code>docker login</code>命令登录你的Nexus Docker registry：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> login leite-dev:18081</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>推送和拉取镜像</strong>: 标记你的镜像并推送到Nexus：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> tag your-image leite-dev:18081/your-image</span>
<span class="line"><span class="token function">docker</span> push leite-dev:18081/your-image</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>拉取镜像时，直接使用pull命令：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> pull leite-dev:18081/your-image</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><h2 id="配置阿里云docker-镜像" tabindex="-1"><a class="header-anchor" href="#配置阿里云docker-镜像"><span>配置阿里云docker 镜像</span></a></h2><p><code>https://cr.console.aliyun.com/cn-shanghai/instances</code></p><p>密码：le130</p><h2 id="删除所有容器的日志文件" tabindex="-1"><a class="header-anchor" href="#删除所有容器的日志文件"><span>删除所有容器的日志文件</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;truncate -s 0 /var/lib/docker/containers/*/*-json.log&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="mysql以容器运行时-增量备份" tabindex="-1"><a class="header-anchor" href="#mysql以容器运行时-增量备份"><span>mysql以容器运行时，增量备份</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token comment">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">FULL_BACKUP_DIR</span><span class="token operator">=</span><span class="token string">&quot;/backup/full_backup&quot;</span></span>
<span class="line"><span class="token comment"># 备份目录</span></span>
<span class="line"><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">&quot;/backup/incremental&quot;</span></span>
<span class="line"><span class="token comment"># 位置信息文件</span></span>
<span class="line"><span class="token assign-left variable">POSITION_FILE</span><span class="token operator">=</span><span class="token string">&quot;/backup/last_position.txt&quot;</span></span>
<span class="line"><span class="token assign-left variable">DATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建备份目录（如果不存在）</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /backup</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 先创建目录</span></span>
<span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> local-oa-base-services-mysql-1 <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;mkdir -p <span class="token variable">$BACKUP_DIR</span> &amp;&amp; mkdir -p <span class="token variable">$FULL_BACKUP_DIR</span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 如果是第一次运行，需要先进行全量备份并记录位置</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token variable">$POSITION_FILE</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment"># 进行全量备份</span></span>
<span class="line">    <span class="token function">docker</span> <span class="token builtin class-name">exec</span> local-oa-base-services-mysql-1 <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;mysqldump -u root -proot \</span>
<span class="line">        --single-transaction \</span>
<span class="line">        --master-data=2 \</span>
<span class="line">        --databases area_oa &gt; <span class="token variable">$FULL_BACKUP_DIR</span>/full_<span class="token variable">$DATE</span>.sql&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 记录当前位置</span></span>
<span class="line">    <span class="token function">docker</span> <span class="token builtin class-name">exec</span> local-oa-base-services-mysql-1 mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-proot</span> <span class="token punctuation">\</span></span>
<span class="line">        <span class="token parameter variable">-e</span> <span class="token string">&quot;SHOW MASTER STATUS\G&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;File\|Position&quot;</span> <span class="token operator">&gt;</span> <span class="token variable">$POSITION_FILE</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token comment"># 读取上次备份的位置信息</span></span>
<span class="line">    <span class="token assign-left variable">LAST_FILE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">&quot;File:&quot;</span> $POSITION_FILE <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">)</span></span></span>
<span class="line">    <span class="token assign-left variable">LAST_POS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">&quot;Position:&quot;</span> $POSITION_FILE <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">)</span></span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 获取当前位置</span></span>
<span class="line">    <span class="token function">docker</span> <span class="token builtin class-name">exec</span> local-oa-base-services-mysql-1 mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-proot</span> <span class="token punctuation">\</span></span>
<span class="line">        <span class="token parameter variable">-e</span> <span class="token string">&quot;SHOW MASTER STATUS\G&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;File\|Position&quot;</span> <span class="token operator">&gt;</span> /tmp/current_position.txt</span>
<span class="line">    </span>
<span class="line">    <span class="token assign-left variable">CURRENT_FILE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">&quot;File:&quot;</span> /tmp/current_position.txt <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">)</span></span></span>
<span class="line">    <span class="token assign-left variable">CURRENT_POS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">&quot;Position:&quot;</span> /tmp/current_position.txt <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">)</span></span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 执行增量备份</span></span>
<span class="line">    <span class="token function">docker</span> <span class="token builtin class-name">exec</span> local-oa-base-services-mysql-1 <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;mysqlbinlog \</span>
<span class="line">        --start-position=<span class="token variable">$LAST_POS</span> \</span>
<span class="line">        --stop-position=<span class="token variable">$CURRENT_POS</span> \</span>
<span class="line">        /var/lib/mysql/<span class="token variable">$LAST_FILE</span> &gt; <span class="token variable">$BACKUP_DIR</span>/incremental_<span class="token variable">$DATE</span>.sql&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 更新位置信息</span></span>
<span class="line">    <span class="token function">cp</span> /tmp/current_position.txt <span class="token variable">$POSITION_FILE</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意分清是主机的目录，还是窗器内的目录</p><p>恢复备份：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 恢复全量备份</span></span>
<span class="line">mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-proot</span> <span class="token operator">&lt;</span> full_backup.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 恢复增量备份</span></span>
<span class="line">mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-proot</span> <span class="token operator">&lt;</span> incremental_backup.sql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h2 id="查询正在运行的容器的环境变量" tabindex="-1"><a class="header-anchor" href="#查询正在运行的容器的环境变量"><span>查询正在运行的容器的环境变量</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>container_id<span class="token operator">&gt;</span> <span class="token function">env</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="docker-swarm" tabindex="-1"><a class="header-anchor" href="#docker-swarm"><span>Docker Swarm</span></a></h2><h3 id="docker-swarm-简介" tabindex="-1"><a class="header-anchor" href="#docker-swarm-简介"><span>Docker Swarm 简介</span></a></h3><p>Docker Swarm 是实现Docker 规模化的关键方案。其核心包含一个安全集群组件和一个编排组件。</p><ul><li>从集群角度来说，Swarm将一个或多个Docker节点组织起来，使得用户能够以集群方式管理它们。</li><li>从编排角度来说，Swarm提供了一套丰富的API使得部署和管理复杂的微服务应用变得易如反掌。</li></ul><h3 id="docker-swarm-详解" tabindex="-1"><a class="header-anchor" href="#docker-swarm-详解"><span>Docker Swarm 详解</span></a></h3><h4 id="swarm-的基本架构" tabindex="-1"><a class="header-anchor" href="#swarm-的基本架构"><span>Swarm 的基本架构</span></a></h4><p>Swarm 由一个或多个Docker节点组成，这些节点可以是物理服务器、虚拟机、树莓派（Raspberry Pi）或云实例。</p><ul><li>节点类型： <ul><li>管理节点（Manager）：负责集群控制面（Control Plane），进行诸如监控集群状态、分发任务至工作节点等操作。</li><li>工作节点（Worker）：接收来自管理节点的任务并执行。</li></ul></li><li>Swarm的配置和状态信息保存在一套位于所有管理节点上的分布式etcd数据库中。</li><li>Swarm 使用TLS进行通信加密、节点认证和角色授权，并支持自动密钥轮换。</li></ul><h4 id="搭建安全-swarm-集群" tabindex="-1"><a class="header-anchor" href="#搭建安全-swarm-集群"><span>搭建安全 Swarm 集群</span></a></h4><p>搭建Swarm集群的过程也被称为初始化Swarm，大体流程包括初始化第一个管理节点&gt;加入额外的管理节点&gt;加入工作节点&gt;完成。</p><ol><li><p><strong>初始化一个全新的Swarm</strong>：不包含在任何Swarm中的Docker节点，称为运行于单引擎（Single-Engine）模式。一旦被加入Swarm集群，则切换为Swarm模式。</p><div style="text-align:center;"><img src="/assets/image-20250107095044943-DVRvT6VQ.png" alt="image-20250107095044943" style="zoom:50%;"></div><p>(1) 初始化 Swarm 集群命令：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> swarm init <span class="token punctuation">\</span></span>
<span class="line">  --advertise-addr <span class="token number">10.0</span>.0.1:2377 <span class="token punctuation">\</span></span>
<span class="line">  --listen-addr <span class="token number">10.0</span>.0.1:2377</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>--advertise-addr</code> 指定其他节点用来连接到当前管理节点的IP和端口。这一属性是可选的，当节点上有多个IP时，可以用于指定使用哪个IP。</p><p><code>--listen-addr</code> 指定用于承载Swarm流量的IP和端口。其设置通常与--advertise-addr 相匹配，但是当节点上有多个IP的时候，可用于指定具体某个IP。</p><p>Swarm模式下的操作默认运行于2337端口，虽然可配，但2377/tcp 是用于客户端与Swarm进行安全（HTTPS）通信的约定俗成的端口配置。</p></blockquote><p>执行完命令以后，并将自身设置为第一个管理节点。同时也会使该节点开启Swarm模式。</p><p>(2) 列出Swarm中的节点</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>(3) 生成其它节点加入swarm需要的token</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">## 工作节点</span></span>
<span class="line"><span class="token function">docker</span> swarm join-token worker</span>
<span class="line"><span class="token comment">## 管理节点</span></span>
<span class="line"><span class="token function">docker</span> swarm join-token manager</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>一个节点是作为工作节点还是管理节点接入，完全依赖于使用了哪个Token.</p></blockquote><p>(4) 加入节点</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> swarm <span class="token function">join</span> <span class="token parameter variable">--token</span> <span class="token operator">&lt;</span>token<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>manager-ip<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token punctuation">\</span></span>
<span class="line">  --advertise-addr <span class="token operator">&lt;</span>node-ip<span class="token operator">&gt;</span> <span class="token punctuation">\</span></span>
<span class="line">  --listen-addr <span class="token operator">&lt;</span>node-ip<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ul><li><p><code>&lt;manager-ip&gt;</code> 为管理节点的IP，其中--advertise-addr 和 --listen-addr 是可选的，当节点上有多个IP时，可以用于指定使用哪个IP，<code>&lt;node-ip&gt;</code> 为当前节点的IP。</p></li><li><p>当token为工作节点时，则加入工作节点，当token为管理节点时，则加入管理节点。</p></li><li><p>每次将节点加入Swarm都指定--advertise-addr 与--listen-addr 属性是痛苦的。然而，一旦Swarm中的网络配置出现问题将会更加痛苦。况且，手动将节点加入Swarm也不是一种日常操作，所以在执行该命令时额外指定这两个属性是值得的。</p></li></ul></blockquote><p>(5) 列出Swarm中的节点 在任意管理节点上执行</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>Swarm 管理器高可用性（HA）</strong>：Swarm 的管理节点内置有对HA的支持，这意味着即使一个或多个节点发生故障，剩余管理节点也会继续保证Swarm的运转。</p><ul><li>Swarm 实现了一种主从方式的多管理节点的HA。这意味着，有多个管理节点，也总是仅有一个节点处于活动状态。通常处于活动状态的管理节点被称为“主节点”​（leader）​，而主节点也是唯一一个会对Swarm发送控制命令的节点。如果一个备用（非活动）管理节点接收到了Swarm命令，则它会将其转发给主节点。Swarm使用了<a class="route-link" href="/Backend/docker/raft.html">Raft共识算法</a>的一种具体实现来支持管理节点的HA</li></ul><div style="text-align:center;"><img src="/assets/Image00049-3_q_eWLY.jpg" alt="Image00049" style="zoom:50%;"></div><ul><li>最佳实践原则： <ul><li>部署奇数个管理节点。</li><li>不要部署太多管理节点（建议3个或5个）。</li></ul><blockquote><p>部署奇数个管理节点有利于减少<a class="route-link" href="/Backend/docker/split-brain.html">脑裂（Split-Brain）</a>的风险。</p></blockquote></li><li>建议将管理节点分布到不同的可用域（Availability Zone）中。</li></ul></li><li><p><strong>内置的 Swarm 安全机制</strong>：Swarm 集群内置有繁多的安全机制，并提供了开箱即用的合理的默认配置，例如 CA 设置、接入Token、公用TLS、加密集群存储、加密网络、加密节点 ID 等。</p></li><li><p><strong>锁定 Swarm</strong>：Docker 提供了自动锁机制来锁定 Swarm，强制要求重启的管理节点在提供一个集群解锁码之后才有权从新接入集群。如果没有锁定机制，重启一个旧的管理节点或进行备份恢复仍有可能对集群造成影响。一个旧的管理节点重新接入Swarm会自动解密并获得Raft数据库中长时间序列的访问权，这会带来安全隐患。进行备份恢复可能会抹掉最新的Swarm配置。</p><ul><li>在执行<code>docker swarm init</code>命令时，传入<code>--auto-lock</code>选项，Swarm 会自动启用锁定机制。</li><li>如果前面已经启用了一个Swarm集群，则可以使用<code>docker swarm update --autolock=true</code>命令来启用锁定机制。</li><li>请确保将解锁码妥善保管在安全的地方<a class="route-link" href="/Backend/docker/forget-lock-psw.html">忘记解锁码</a></li><li>如果管理节点重启，则需要使用<code>docker swarm unlock</code>命令为重启的管理节点解锁Swarm</li></ul></li></ol><h3 id="swarm-服务" tabindex="-1"><a class="header-anchor" href="#swarm-服务"><span>Swarm 服务</span></a></h3><p>Swarm 中的最小调度单元是服务，它是随 Swarm 引入的，在API中是一个新的对象元素，它基于容器封装了一些高级特性。服务仅适用于Swarm模式。</p><ol><li><strong>创建服务</strong></li></ol><p>使用服务仍能够配置大多数熟悉的容器属性，比如容器名、端口映射、接入网络和镜像。<code>--replicas</code> 选项用于指定服务需要运行的副本数量。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> create <span class="token parameter variable">--name</span> my_service <span class="token parameter variable">--replicas</span> <span class="token number">3</span> <span class="token parameter variable">--publish</span> <span class="token number">8080</span>:80 nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li><strong>查看服务</strong></li></ol><p>查看Swarm中的所有的服务</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> <span class="token function">ls</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看某个服务的副本及状态</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> <span class="token function">ps</span> <span class="token operator">&lt;</span>service_name or id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看某个服务的更详细的信息</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> inspect <span class="token operator">&lt;</span>service_name or id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>可以使用<code>--pretty</code>选项来格式化输出</p></blockquote><ol start="3"><li><strong>副本服务VS全局服务</strong></li></ol><ul><li><p>副本服务： 服务的默认是副本模式（replicated ）​。这种模式会部署期望数量的服务副本，并尽可能均匀地将各个副本分布在整个集群中。</p></li><li><p>全局服务： 全局模式（global ）​，在这种模式下，每个节点上仅运行一个副本。可以通过给<code>docker service create</code>命令传递<code>--mode global</code>参数来部署一个全局服务。</p></li></ul><div class="hint-container note"><p class="hint-container-title">Note</p><p>默认模式下，是在Swarm中的所有节点开放端口——即使节点上没有服务的副本——称为入站模式（Ingress Mode）​。此外还有主机模式（Host Mode）​，即仅在运行有容器副本的节点上开放端口。声明为主机模式，需要较长的命令。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> create <span class="token parameter variable">--name</span> uber-svc <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">--network</span> uber-net <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">--publish</span> <span class="token assign-left variable">published</span><span class="token operator">=</span><span class="token number">80</span>,target<span class="token operator">=</span><span class="token number">80</span>,mode<span class="token operator">=</span>host <span class="token punctuation">\</span></span>
<span class="line">   <span class="token parameter variable">--replicas</span> <span class="token number">12</span> <span class="token punctuation">\</span></span>
<span class="line">   nigelpoulton/tu-demo:v1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><ol start="4"><li><strong>服务的扩缩容</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> scale <span class="token operator">&lt;</span>service_name or id<span class="token operator">&gt;=</span><span class="token operator">&lt;</span>number_of_replicas<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>通过这个命令可以扩展或缩减服务。</p><blockquote><p>在底层实现上，Swarm执行了一个调度算法，默认将副本尽量均衡分配给Swarm中的所有节点</p></blockquote><ol start="5"><li><strong>删除服务</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>service_name or id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>谨慎使用docker service rm 命令，因为它在删除所有服务副本时并不会进行确认。</p></blockquote><ol start="6"><li><strong>滚动更新</strong></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> update <span class="token parameter variable">--image</span> <span class="token operator">&lt;</span>new_image<span class="token operator">&gt;</span> <span class="token punctuation">\</span></span>
<span class="line">    --update-delay 10s <span class="token punctuation">\</span></span>
<span class="line">    --update-parallelism <span class="token number">2</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token operator">&lt;</span>service_name or id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>--update-delay</code> 选项用于指定更新延迟时间，<code>--update-parallelism</code> 选项用于指定更新并行度。对服务执行<code>docker inspect &lt;service_name or id&gt; --pretty</code> 命令，会发现更新时对并行和延迟的设置已经成为服务定义的一部分了。这意味着，之后的更新操作将会自动使用这些设置，直到再次使用<code>docker service update</code> 命令覆盖它们。</p></blockquote><h3 id="swarm日志查询" tabindex="-1"><a class="header-anchor" href="#swarm日志查询"><span>Swarm日志查询</span></a></h3><p>可以通过查看日志来定位问题。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">service</span> logs <span class="token operator">&lt;</span>service_name or id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>输出日志<code>svc1.1.zhc3cjeti9d4@wrk-2 | [emerg] 1#1: host not found...</code></p><p>每一行开头为副本名称，其中包括服务名称、副本编号、副本ID以及所在的主机。如果服务没有启动成功，副本编号可能一直是1，直到服务成功启动。</p><h3 id="docker-swarm-命令" tabindex="-1"><a class="header-anchor" href="#docker-swarm-命令"><span>Docker Swarm 命令</span></a></h3><p>以下是一些常用的 Docker Swarm 命令：</p><p><strong>Swarm集群管理</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 初始化Swarm集群</span></span>
<span class="line"><span class="token function">docker</span> swarm init --advertise-addr <span class="token operator">&lt;</span>MANAGER-IP<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 获取工作节点的加入命令</span></span>
<span class="line"><span class="token function">docker</span> swarm join-token worker</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 获取管理节点的加入命令</span></span>
<span class="line"><span class="token function">docker</span> swarm join-token manager</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 加入Swarm集群</span></span>
<span class="line"><span class="token function">docker</span> swarm <span class="token function">join</span> <span class="token parameter variable">--token</span> <span class="token operator">&lt;</span>TOKEN<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>MANAGER-IP<span class="token operator">&gt;</span>:2377</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 列出集群中的节点</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>服务管理</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 创建服务</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> create <span class="token parameter variable">--name</span> <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;</span> <span class="token parameter variable">--replicas</span> <span class="token operator">&lt;</span>N<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>IMAGE<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 列出所有服务</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> <span class="token function">ls</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看服务详情</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> inspect <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;</span> <span class="token parameter variable">--pretty</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看服务的任务/容器列表</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> <span class="token function">ps</span> <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看服务日志</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> logs <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>服务扩缩容和更新</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 扩缩容服务</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> scale <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;=</span><span class="token operator">&lt;</span>NUMBER<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 更新服务</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> update <span class="token punctuation">\</span></span>
<span class="line">  <span class="token parameter variable">--image</span> <span class="token operator">&lt;</span>NEW-IMAGE<span class="token operator">&gt;</span> <span class="token punctuation">\</span></span>
<span class="line">  --update-delay 10s <span class="token punctuation">\</span></span>
<span class="line">  --update-parallelism <span class="token number">2</span> <span class="token punctuation">\</span></span>
<span class="line">  <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 删除服务</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">service</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>SERVICE-NAME<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>节点管理</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 将节点设置为维护模式</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">node</span> update <span class="token parameter variable">--availability</span> drain <span class="token operator">&lt;</span>NODE-ID<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 将节点恢复为活动状态</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">node</span> update <span class="token parameter variable">--availability</span> active <span class="token operator">&lt;</span>NODE-ID<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 从Swarm中删除节点</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">node</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>NODE-ID<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 提升工作节点为管理节点</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">node</span> promote <span class="token operator">&lt;</span>NODE-ID<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 降级管理节点为工作节点</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">node</span> demote <span class="token operator">&lt;</span>NODE-ID<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="docker-网络" tabindex="-1"><a class="header-anchor" href="#docker-网络"><span>Docker 网络</span></a></h2><h3 id="docker-网络——简介" tabindex="-1"><a class="header-anchor" href="#docker-网络——简介"><span>Docker 网络——简介</span></a></h3><p>Docker 需要强大的网络功能，因为容器内的应用程序需要通过各种网络进行交互。</p><p><strong>Docker 网络架构建立在一个名为容器网络模型（CNM）的概念之上，它开源且可插拔。</strong> Libnetwork 是 Docker 对 CNM 的实现。</p><p><strong>为了开箱即用，Docker 包含了许多本机驱动程序，它们涵盖了最常见的用例。</strong> 其中包括用于单主机连接的桥接网络、用于多主机连接的覆盖网络以及连接到现有 VLAN 的功能。</p><p>Libnetwork 实现了基本的<strong>服务发现</strong>和基本容器负载均衡。</p><h3 id="docker-网络——详解" tabindex="-1"><a class="header-anchor" href="#docker-网络——详解"><span>Docker 网络——详解</span></a></h3><p>本节内容分为基础知识、单主机桥接网络、多主机覆盖网络、连接到现有网络、服务发现和 Ingress 网络。</p><h4 id="基础知识" tabindex="-1"><a class="header-anchor" href="#基础知识"><span><strong>基础知识</strong></span></a></h4><p><strong>在最高级别，Docker 网络架构由三部分组成：CNM、Libnetwork 和驱动程序。</strong></p><ul><li><p><strong>CNM</strong> 是设计规范，它指定了 Docker 网络架构的基本构建块。</p><ul><li><p>CNM 定义了三个基本网络元素：<strong>沙盒、端点和网络</strong>。</p><ul><li>沙盒是一个独立的网络堆栈(包括以太网接口、端口、路由表以及DNS配)。</li><li>端点是一个虚拟网络接口(像普通网络接口一样，终端主要职责是负责创建连接。在CNM中，终端负责将沙盒连接到网络)。</li><li>网络是 802.1d 网桥的软件实现(网络就是需要交互的终端的集合，并且终端之间相互独立)。</li></ul><p>三个元素组合图【CNM】:</p><div style="text-align:center;"><img src="/assets/Image00054-7vMDZSld.jpg" alt="Image00054" style="zoom:50%;"></div><p>CNM组件与容器进行关联:</p><div style="text-align:center;"><img src="/assets/Image00055-Bxkq4TEb.jpg" alt="Image00055" style="zoom:50%;"></div><div class="hint-container note"><p class="hint-container-title">Note</p><p>容器A与B之间是可以相互通信的，因为都接入了网络A。但是，如果没有三层路由器的支持，容器B的两个终端之间是不能进行通信的。</p><p>需要重点理解的是，终端与常见的网络适配器类似，这意味着终端只能接入某一个网络。因此，如果容器需要接入到多个网络，就需要多个终端。</p></div><p>加入Docker主机：</p><div style="text-align:center;"><img src="/assets/Image00056-CzaXB_IM.jpg" alt="Image00056" style="zoom:40%;"></div><div class="hint-container note"><p class="hint-container-title">Note</p><p>虽然容器A和容器B运行在同一个主机上，但其网络堆栈在操作系统层面是互相独立的，这一点由沙盒机制保证。</p></div></li><li><p><strong>Libnetwork</strong> 是 CNM 的开源且跨平台的实现，由 Docker 使用。</p><ul><li>Docker 将网络代码从守护进程中分离出来，并将其重构到一个名为 Libnetwork 的外部库中。</li><li>Libnetwork 实现了 CNM 中指定的所有三个组件。它还实现了本机服务发现、基于 Ingress 的容器负载均衡以及网络控制和管理功能。</li></ul></li><li><p><strong>驱动程序</strong> 如果说Libnetwork实现了控制层和管理层功能，那么驱动就负责实现数据层。比如，网络连通性和隔离性是由驱动来处理的。</p><ul><li>Docker 包括多个内置驱动程序，通常称为本机或本地驱动程序，包括用于 Linux 的 Bridge、Overlay 和 Macvlan，以及用于 Windows 的 NAT、Overlay、传输和 L2Bridge。</li><li>第三方还可以编写 Docker 网络驱动程序。这些被称为远程驱动程序。示例包括 Calico、Contiv、Kuryr 和 Weave。</li></ul><p>控制层、管理层与数据层的关系:</p><div style="text-align:center;"><img src="/assets/Image00057-Dnq5LZMW.jpg" alt="Image00057" style="zoom:50%;"></div></li></ul></li></ul><h4 id="单主机桥接网络" tabindex="-1"><a class="header-anchor" href="#单主机桥接网络"><span><strong>单主机桥接网络</strong></span></a></h4><p>最简单的 Docker 网络是单主机桥接网络。顾名思义，这种类型的网络仅在单个 Docker 主机上运行，并且只能连接到同一主机上的容器。除非通过命令行创建容器时指定参数--network ，否则默认情况下，新创建的容器都会连接到该网络。不同主机内的容器之间无法通过单主机桥接网络进行通信。</p><div style="text-align:center;"><img src="/assets/Image00058-ecuzg_us.jpg" alt="Image00058" style="zoom:50%;"></div><div class="hint-container note"><p class="hint-container-title">Note</p><p>Linux Docker 使用内置的 Bridge 驱动程序创建单主机桥接网络。 Windows Docker 使用内置的 NAT 驱动程序来创建它们。</p></div><p>刚完成安装的Docker主机, 默认会创建一个“bridge”【名字不一定叫bridge】网络。 Docker默认“bridge”网络和Linux内核中的“docker0”网桥之间的关系如图:</p><div style="text-align:center;"><img src="/assets/Image00059-C_cqgBdx.jpg" alt="Image00059" style="zoom:50%;"></div><p>在顶部补充了接入“bridge”网络的容器。​“bridge”网络在主机内核中映射到名为“docker0”的Linux网桥，该网桥可以通过主机以太网接口的端口映射进行反向关联。<a class="route-link" href="/Backend/network/network-basis.html#linux%E7%B3%BB%E7%BB%9F%E4%B8%AD-%E4%BB%A5%E5%A4%AA%E7%BD%91%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%91%BD%E5%90%8D">ethx</a></p><div style="text-align:center;"><img src="/assets/Image00060-C-3LXYnA.jpg" alt="Image00060" style="zoom:50%;"></div><p>创建新的网络</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> network create <span class="token parameter variable">-d</span> bridge localnet</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>创建新的容器跑在上面创建的网络上</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> c1 <span class="token punctuation">\</span></span>
<span class="line">  <span class="token parameter variable">--network</span> localnet <span class="token punctuation">\</span></span>
<span class="line">  alpine <span class="token function">sleep</span> 1d</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果在相同网络中继续接入新的容器，那么在新接入容器中是可以通过“c1”的容器名称来ping通的。这是因为新容器都注册到了指定的Docker DNS服务</p><div class="hint-container warning"><p class="hint-container-title">Warning</p><p>Linux上默认的Bridge网络是不支持通过Docker DNS服务进行域名解析的。自定义桥接网络可以！</p></div><h4 id="多主机覆盖网络" tabindex="-1"><a class="header-anchor" href="#多主机覆盖网络"><span><strong>多主机覆盖网络</strong></span></a></h4><p>在现实世界中，跨不同主机上的不同网络的容器之间的可靠且安全的通信非常重要。覆盖网络允许用户创建安全的扁平二层网络，以连接多个主机。</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>Docker 覆盖网络的创建是为了解决容器之间跨网络通信的问题，而不是为了解决节点加入 swarm 集群的问题。</p><p>Swarm 集群的管理节点和工作节点之间使用的是标准的 TCP 协议进行通信，默认端口为 2377。</p><p>只要工作节点能够通过 IP 网络访问到管理节点上的该端口，它就可以成功加入集群。</p></div><p><strong>Docker 覆盖网络使用 VXLAN 来连接网络。</strong></p><p>VXLAN 是 Virtual Extensible LAN 的缩写，中文译为虚拟可扩展局域网。 VXLAN 是一种网络虚拟化技术，允许您在现有三层网络上创建虚拟二层网络。 它通过在 UDP 数据包中封装以太网帧来实现这一点，从而使您能够在不同的物理位置上的主机之间扩展二层网络。 Docker 使用 VXLAN 隧道技术来创建虚拟二层覆盖网络。VXLAN隧道两端都是VXLAN隧道终端（VXLAN TunnelEndpoint, VTEP）​。VTEP完成了封装和解压的步骤。</p><p>VXLAN设计图</p><div style="text-align:center;"><img src="/assets/Image00079-CBPnn-wv.jpg" alt="Image00079" style="zoom:50%;"></div><p>不同主机的VTEP创建覆盖网络：</p><div style="text-align:center;"><img src="/assets/Image00080-BtH2Qkd-.jpg" alt="Image00080" style="zoom:40%;"></div><p>以太网（veth ）适配器接入本地Br0虚拟交换机:</p><div style="text-align:center;"><img src="/assets/Image00081-_mfc9ACt.jpg" alt="Image00081" style="zoom:40%;"></div><h4 id="连接到现有网络" tabindex="-1"><a class="header-anchor" href="#连接到现有网络"><span><strong>连接到现有网络</strong></span></a></h4><p><strong>Macvlan 驱动程序（在 Windows 中为透明）允许容器连接到现有的物理网络和 VLAN。</strong> 它通过为容器提供 MAC 和 IP 地址，使其成为网络上的“一等公民”。示意图如下</p><div style="text-align:center;"><img src="/assets/Image00065-Cecnsie1.jpg" alt="Image00065" style="zoom:50%;"></div><p><strong>此驱动程序要求主机的 NIC 支持混杂模式。</strong> 这意味着无法在大多数公共云上使用此驱动程序。</p><p>创建Macvlan网络</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> network create <span class="token parameter variable">-d</span> macvlan <span class="token punctuation">\</span></span>
<span class="line">  <span class="token parameter variable">--subnet</span><span class="token operator">=</span><span class="token number">10.0</span>.0.0/24 <span class="token punctuation">\</span></span>
<span class="line">  --ip-range<span class="token operator">=</span><span class="token number">10.0</span>.00/25 <span class="token punctuation">\</span></span>
<span class="line">  <span class="token parameter variable">--gateway</span><span class="token operator">=</span><span class="token number">10.0</span>.0.1 <span class="token punctuation">\</span></span>
<span class="line">  <span class="token parameter variable">-o</span> <span class="token assign-left variable">parent</span><span class="token operator">=</span>eth0.100 <span class="token punctuation">\</span></span>
<span class="line">  macvlan100</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建容器跑在上面创建的网络上</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mactainer1 <span class="token punctuation">\</span></span>
<span class="line">  <span class="token parameter variable">--network</span> macvlan100 <span class="token punctuation">\</span></span>
<span class="line">  alpine <span class="token function">sleep</span> 1d</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时的网络示意图如下</p><div style="text-align:center;"><img src="/assets/Image00069-CfKLEY_h.jpg" alt="Image00069" style="zoom:50%;"></div><div class="hint-container warning"><p class="hint-container-title">Warning</p><p>如果上述命令不能执行，可能是因为主机NIC不支持混杂模式。切记公有云平台不允许混杂模式</p></div><h4 id="服务发现" tabindex="-1"><a class="header-anchor" href="#服务发现"><span><strong>服务发现</strong></span></a></h4><p>Libnetwork 包含对基本服务发现的支持。</p><h4 id="ingress-网络" tabindex="-1"><a class="header-anchor" href="#ingress-网络"><span><strong>Ingress 网络</strong></span></a></h4><p>Docker 还包含一个服务网格，支持对入站流量进行基于容器的负载均衡。在底层，Ingress模式采用名为Service Mesh 或者SwarmMode Service Mesh 的四层路由网络来实现。</p><p>Ingress模式下访问服务:</p><div style="text-align:center;"><img src="/assets/Image00073-CU__a3ex.jpg" alt="Image00073" style="zoom:50%;"></div><p>图中最上方命令部署了一个名为“svc1”的Swarm服务。该服务连接到了overnet 网络，并发布到5000端口。集群确保到达Ingress网络中任意节点 的5000端口的流量，都会被路由到80端口的“svc1”服务。</p><h3 id="docker-网络——命令" tabindex="-1"><a class="header-anchor" href="#docker-网络——命令"><span>Docker 网络——命令</span></a></h3><ul><li><code>docker network ls</code> 用于列出在本地 Docker 主机上运行的所有网络。</li><li><code>docker network create</code> 用于创建新网络。</li><li><code>docker network inspect</code> 用于提供有关 Docker 网络的详细信息。</li><li><code>docker network prune</code> 用于删除 Docker 主机上的所有未使用网络。</li><li><code>docker network rm</code> 用于删除 Docker 主机上的特定网络。</li></ul><h3 id="docker-网络——小结" tabindex="-1"><a class="header-anchor" href="#docker-网络——小结"><span>Docker 网络——小结</span></a></h3><ul><li><p><strong>容器网络模型（CNM）是 Docker 网络架构的主要设计文档。</strong> 它指定了 Docker 网络中使用的三个主要结构：沙盒、端点和网络。</p></li><li><p><strong>Libnetwork 是一个开源库，用 Go 编写，它实现了 CNM。</strong> Docker 使用此库，并且 Docker 网络架构的核心代码都位于此库中。Libnetwork 还提供 Docker 网络控制和管理功能。</p></li><li><p><strong>驱动程序通过实现特定网络类型来扩展 Docker 网络堆栈（Libnetwork），</strong> 例如桥接和覆盖网络。Docker 包含多个内置驱动程序，并支持第三方驱动程序。</p></li><li><p><strong>单主机桥接网络是一种基本 Docker 网络类型，适合本地开发和小型应用程序。</strong> 单主机桥接网络不可扩展，并且依赖端口映射进行服务发布。Linux Docker 使用内置的 Bridge 驱动程序实现单主机桥接网络，而 Windows Docker 使用内置的 NAT 驱动程序来实现。</p></li><li><p><strong>覆盖网络是当今非常流行的网络形式，并且是用于多主机容器网络的绝佳解决方案。</strong></p></li><li><p><strong>Macvlan 驱动程序（在 Windows 中为透明）允许容器连接到现有的物理网络和 VLAN。</strong> 通过为容器提供 MAC 和 IP 地址，使其成为网络上的“一等公民”。但是，此驱动程序要求主机的 NIC 支持混杂模式，这意味着无法在公共云上使用此驱动程序。</p></li><li><p><strong>Docker 在 Libnetwork 中包含对基本服务发现的支持，</strong> <strong>还包含一个服务网格，支持对入站流量进行基于容器的负载均衡。</strong></p></li></ul><h2 id="docker卷与持久化数据" tabindex="-1"><a class="header-anchor" href="#docker卷与持久化数据"><span>Docker卷与持久化数据</span></a></h2><h3 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h3><p>数据主要分为两类：</p><ul><li><strong>持久化数据：</strong> 需要保存的数据，例如客户信息、财务、预定、审计日志以及某些应用日志数据。</li><li><strong>非持久化数据：</strong> 不需要保存的那些数据。</li></ul><p>Docker 对这两种数据类型都有相应的支持方式。</p><ul><li><strong>每个 Docker 容器都有自己的非持久化存储</strong>，该存储会自动创建，属于容器的一部分，生命周期与容器相同。 这意味着删除容器也会删除全部非持久化数据。</li><li>如果希望容器数据保留下来（持久化），则需要将数据存储在<strong>卷</strong>上。 <strong>卷与容器是解耦的</strong>，从而可以独立地创建并管理卷，并且卷并未与任意容器生命周期绑定。 最终效果是，用户可以删除一个关联了卷的容器，但是卷并不会被删除。</li></ul><h3 id="详解" tabindex="-1"><a class="header-anchor" href="#详解"><span>详解</span></a></h3><p>对于微服务设计模式来说，容器是不错的选择。通常与微服务挂钩的词有“暂时”以及“无状态”。 所以，微服务就是无状态的、临时的工作负载，同时“容器即微服务”。 因此，我们经常会轻易下结论，认为容器就是用于临时场景。 但这种说法是错误的！</p><h4 id="容器与非持久数据" tabindex="-1"><a class="header-anchor" href="#容器与非持久数据"><span>容器与非持久数据</span></a></h4><p>毫无疑问，容器擅长无状态和非持久化事务。</p><p>每个容器都被自动分配了本地存储，默认情况下，这是容器全部文件和文件系统保存的地方。 你可能听过一些非持久存储相关的名称，如本地存储、GraphDriver 存储以及 SnapShotter 存储。 总之，<strong>非持久存储属于容器的一部分，并且与容器的生命周期一致</strong>：容器创建时会创建非持久化存储，同时该存储也会随容器的删除而删除。</p><p>在 Linux 系统中，该存储的目录在 <code>/var/lib/docker/&lt;storage-driver&gt;/</code> 之下，是容器的一部分。 在 Windows 系统中位于 <code>C\ProgramData\Docker\windowsfilter\</code> 目录之下。</p><p>如果在生产环境中使用 Linux 运行 Docker，需要确认当前存储驱动 （GraphDriver） 与 Linux 版本是否相符。</p><h4 id="容器与持久化数据" tabindex="-1"><a class="header-anchor" href="#容器与持久化数据"><span>容器与持久化数据</span></a></h4><p>如果容器需要保存持久化数据，则必须将数据存储在卷上。</p><p>卷与容器是解耦的，可以独立创建和管理。这意味着可以将卷创建在某个地方，然后将其挂载到一个或多个容器上。 删除容器并不会删除卷，其上存储的数据也会保留下来。</p><p>从技术上讲，卷是位于 Docker 主机文件系统 <code>/var/lib/docker/volumes/</code> (Linux) 或 <code>C:\ProgramData\docker\volumes\</code> (Windows) 上的目录，属于 Docker 主机的一部分。</p><p>卷可以由 Docker 管理，也可以由用户管理。</p><h4 id="在集群节点间共享存储" tabindex="-1"><a class="header-anchor" href="#在集群节点间共享存储"><span>在集群节点间共享存储</span></a></h4><p>当需要在 Docker Swarm 集群的多个节点间共享存储时，事情就变得复杂了。</p><p>因为卷本质上只是 Docker 主机上的一个目录，因此无法在不同 Docker 主机间直接共享它。 你需要某种形式的共享存储，例如网络文件系统 (NFS) 或集群文件系统，例如 GlusterFS 或 Ceph。</p><h3 id="命令" tabindex="-1"><a class="header-anchor" href="#命令"><span>命令</span></a></h3><ul><li><strong><code>docker volume create</code></strong>： 用于创建新卷的命令。新卷会自动保存在 Docker 主机上的 <code>/var/lib/docker/volumes/</code> (Linux) 或 <code>C:\ProgramData\docker\volumes\</code> (Windows) 目录下。</li><li><strong><code>docker volume ls</code></strong>： 用于列出 Docker 主机上所有卷的命令。</li><li><strong><code>docker volume inspect</code></strong>： 用于查看卷详情的命令，包括名称、驱动、挂载点以及其他信息。</li><li><strong><code>docker volume prune</code></strong>： 用于删除所有未使用的卷的命令。</li><li><strong><code>docker volume rm</code></strong>： 用于删除指定卷的命令。如果卷当前被某个容器使用，则无法删除。</li></ul><h3 id="小结" tabindex="-1"><a class="header-anchor" href="#小结"><span>小结</span></a></h3><p>数据主要分为两类： 持久化和非持久化数据。 持久化数据是需要保存的，而非持久化数据不需要。 默认情况下，所有容器都有与自身声明周期相同的非持久化存储——本地存储，它非常适用于非持久化数据。 但是，如果容器需要创建长期保存的数据，最好将数据存储到 Docker 卷中。</p><p><strong>Docker 卷是 Docker API 中的一等公民，并使用 docker volume 子命令独立管理。</strong> 这意味着删除容器并不会删除容器所使用的卷。</p><p>在 Docker 环境中，<strong>推荐使用卷来保存持久化数据</strong>。</p><h2 id="其它" tabindex="-1"><a class="header-anchor" href="#其它"><span>其它</span></a></h2><h3 id="反向生成-docker-run-命令" tabindex="-1"><a class="header-anchor" href="#反向生成-docker-run-命令"><span>反向生成 docker run 命令</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock assaflavie/runlike <span class="token operator">&lt;</span>你的容器ID或名称<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1308811723@qq.com">RuanCong</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-B1tdEkzq.js" defer></script>
  </body>
</html>
